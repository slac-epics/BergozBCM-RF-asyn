#
# This file is part of Bergoz BCM-RF EPICS device support. It is subject to
# the license terms in the LICENSE.txt file found in the top-level directory
# of this distribution and at:
#    https://confluence.slac.stanford.edu/display/ppareg/LICENSE.html.
# No part of Bergoz BCM-RF EPICS device support, including this file, may be
# copied, modified, propagated, or distributed except according to the terms
# contained in the LICENSE.txt file.
#

record(longin, "$(P)$(R)ADC_RD")
{
    field(DESC, "Sampled ADC value")
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getAdc $(PORT) $(A)")
    field (SCAN, "I/O Intr")
}

record(longin, "$(P)$(R)SERIALNUM_RD")
{
    field(DESC, "Read BERGOZ serial number")
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getSerial $(PORT) $(A)")
    field(SCAN, "I/O Intr")
    field(HSV,  "MINOR")
    field(LSV,  "MINOR")
}

record(longout, "$(P)$(R)SERIALNUM_UPDATE")
{
    field(DESC, "Update BERGOZ serial number")
    field(DTYP, "stream")
    field(OUT,  "@devBergozBCM.proto updateSerial $(PORT) $(A)")
    field(SCAN, "Passive")
}

record(longin, "$(P)$(R)DELAY_RD")
{
    field(DESC, "Get digital delay value")
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getDelay $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

record(longout, "$(P)$(R)DELAY_WR")
{
    field(DESC, "Set digital delay value")
    field(DTYP, "stream")
    field(OUT,  "@devBergozBCM.proto setDelay $(PORT) $(A)")
    field(SCAN, "Passive")
    info(autosaveFields,"VAL")
}

record(longin, "$(P)$(R)REVERSE_RD")
{
    field(DESC, "Is reverse func activated")
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getReverse $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

record(longin, "$(P)$(R)SWITCHES_RD")
{
    field(DESC, "Get switches position")
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getSwitches $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

record(longout, "$(P)$(R)SWITCHES_WR")
{
    field(DESC, "Set switches position")
    field(DTYP, "stream")
    field(OUT,  "@devBergozBCM.proto setSwitches $(PORT) $(A)")
    field(SCAN, "Passive")
    info(autosaveFields,"VAL")
}

record(longin, "$(P)$(R)AVGPOINTS_RD")
{
    field(DESC, "average number of points")
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getAvgPoints $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

record(longin, "$(P)$(R)CCALHI_RD")
{
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getQcalHi $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

record(longin, "$(P)$(R)CCALLO_RD")
{
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getQcalLo $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

#
# Convert to IEEE-754 32-bit float.
# No INF/NAN, no denormalized numbers.
#
record(calc,"$(P)$(R)CCAL_RD") {
    field(INPA, "$(P)$(R)CCALLO_RD CP MS")
    field(INPB, "$(P)$(R)CCALHI_RD CP MS")
    field(INPC, "0x8000")   # Hi word, sign bit
    field(INPD, "0x7F80")   # Hi word, exponent mask
    field(INPE, "0x00FF")   # Hi word, mantissa mask (incl hidden bit)
    field(INPF, "150")      # Exponent offset plus 23-bit mantissa shift
    field(INPG, "0x0080")   # Mantissa hidden bit
    field(INPJ, "65536")    # Hi/Lo mantissa ratio
    field(CALC, "(A&D?(A&C?-1:1):0)*((G|A&E)*J+B)*2^((A&D)/G-F)")
    field(PREC, "5")
    field(PINI, "YES")
}

record(longin, "$(P)$(R)VCALHI_RD")
{
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getUcalHi $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

record(longin, "$(P)$(R)VCALLO_RD")
{
    field(DTYP, "stream")
    field(INP,  "@devBergozBCM.proto getUcalLo $(PORT) $(A)")
    field(SCAN, "I/O Intr")
}

#
# Convert to IEEE-754 32-bit float.
# No INF/NAN, no denormalized numbers.
#
record(calc,"$(P)$(R)VCAL_RD") {
    field(INPA, "$(P)$(R)VCALLO_RD CP MS")
    field(INPB, "$(P)$(R)VCALHI_RD CP MS")
    field(INPC, "0x8000")   # Hi word, sign bit
    field(INPD, "0x7F80")   # Hi word, exponent mask
    field(INPE, "0x00FF")   # Hi word, mantissa mask (incl hidden bit)
    field(INPF, "150")      # Exponent offset plus 23-bit mantissa shift
    field(INPG, "0x0080")   # Mantissa hidden bit
    field(INPJ, "65536")    # Hi/Lo mantissa ratio
    field(CALC, "(A&D?(A&C?-1:1):0)*((G|A&E)*J+B)*2^((A&D)/G-F)")
    field(PREC, "5")
    field(PINI, "YES")
}

record(stringin, "$(P)$(R)TTY_RD")
{
    field(DESC, "TTY device name")
}

record(longin, "$(P)$(R)SERIALNUM_EXPECT")
{
    field(DESC, "Expected BERGOZ serial number")
    field(FLNK, "$(P)$(R)CALC_SERIALNUM_LOW")
}

record(calcout, "$(P)$(R)CALC_SERIALNUM_LOW") {
    field(DESC, "Serial number Min Minor limit")
    field(PREC, "3")
    field(INPA, "$(P)$(R)SERIALNUM_EXPECT.VAL  NPP NMS")
    field(CALC, "A-1")
    field(OUT,  "$(P)$(R)SERIALNUM_RD.LOW  NPP NMS")
    field(SCAN, "Passive")
    field(FLNK, "$(P)$(R)CALC_SERIALNUM_HIGH")
}

record(calcout, "$(P)$(R)CALC_SERIALNUM_HIGH") {
    field(DESC, "Serial number Max Minor limit")
    field(PREC, "3")
    field(INPA, "$(P)$(R)SERIALNUM_EXPECT.VAL  NPP NMS")
    field(CALC, "A+1")
    field(OUT,  "$(P)$(R)SERIALNUM_RD.HIGH NPP NMS")
    field(SCAN, "Passive")
    field(FLNK, "$(P)$(R)SERIALNUM_UPDATE")
}

